# 版本控制
<!-- 2020.03.24 -->

> _进步，远不在于变化，而在于坚持。那些不记得过去的人注定要重蹈覆辙。_
>
> -- _乔治·桑塔亚纳_，《理性生活》

我们在用户界面中寻找的一个重要的东西是 撤销 键 —— 一个可以原谅我们错误的按钮。如果环境支持多个级别的撤消和重做，这样您就可以从几分钟前发生的事情中恢复过来。

但是如果这个错误发生在上周，并且从那以后你已经打开和关闭了十次你的电脑怎么办？好吧，这是使用版本控制系统（VCS）的众多好处之一：它是一个巨大的 撤销 键 —— 一个项目范围内的时间机器，可以让你回到上周那些平静的日子，当代码真正编译和运行时。

对很多人来说，这是他们使用 VCS 的极限。这些人错过了一个更大的协作、部署管道、问题跟踪和一般团队交互的世界。

所以让我们来看看VCS，首先是一个变更存储库，然后是您的团队及其代码的中心会议场所。

---
## 共享目录不是版本控制

    我们偶尔还会遇到一些团队，他们通过网络共享他们的项目源文件：要么在内部共享，要么使用某种云存储。

    这是不可行的。

    这样做的团队不断地扰乱彼此的工作，失去变化，打破构建，并进入停车场拳击。这就像用共享数据编写并发代码，而没有同步机制。使用版本控制。
    但还有更多！有些人使用版本控制，并保留存储库（包含网络或云驱动器上的更改历史记录的位置）。他们认为这是两个世界中最好的：存储库在任何地方都可以访问，而且（在云存储的情况下）是在异地备份的。

    结果更糟，你有失去一切的危险。存储库本身通常是一组相互作用的文件和目录。如果两个人同时提交更改，就不知道会造成多大的损失。没有人喜欢看到开发商哭泣。

---

## 从源头开始

版本控制系统会跟踪您在源代码和文档中所做的每个更改。使用正确配置的源代码控制系统，您始终可以返回到以前版本的软件。

但是，版本控制系统所做的远远不止是纠正错误。一个好的 VCS 会让你跟踪变化，回答诸如：谁在这行代码中做了变化？现在的版本和上周的版本有什么区别？我们在这个版本中更改了多少行代码？哪些文件最常被更改？这类信息对于缺陷跟踪、审计、性能和质量都是非常宝贵的。

VCS还可以让您识别软件的发行版本。一旦确定，您将始终能够返回并重新生成版本，而不受以后可能发生的更改的影响。

版本控制系统可能会将它们维护的文件保存在一个中央存储库中，这是一个很好的归档候选。

最后，版本控制系统允许两个或多个用户同时处理同一组文件，甚至在同一个文件中进行并发更改。然后，当文件发送回存储库时，系统管理这些更改的合并。尽管看起来有风险，但这种系统在各种规模的项目中都能很好地工作。

## 始终使用版本控制

总是使用。即使你是一个一周项目的单人团队。即使它是一个“扔掉”的原型。即使你正在处理的东西不是源代码。确保所有内容都在版本控制文档、电话号码列表、供应商备忘录、makefile、构建和发布过程中，以及整理日志文件的小shell脚本中。我们通常对我们键入的所有内容（包括本书的文本）使用版本控制。即使我们不是在做一个项目，我们的日常工作也会在一个存储库中得到保护。

## 分支出来

版本控制系统不仅保留您的项目的单一历史记录。它们最强大和有用的功能之一就是让您将开发孤岛隔离为称为分支的事物的方式。您可以在项目历史记录中的任何时候创建一个分支，并且您在该分支中所做的任何工作都将与所有其他分支隔离。在将来的某个时候，您可以将正在处理的分支合并回另一个分支，因此目标分支现在包含您在分支中所做的更改。多个人甚至可以在一个分支上工作：在某种程度上，分支就像小克隆项目。

分支机构的好处之一就是它们给您带来的隔离感。如果您在一个分支中开发功能 A，而团队成员在另一个分支中开发功能 B，则您不会互相干扰。
第二个好处可能令人惊讶，那就是分支机构通常是团队项目工作流程的核心。

这就是事情变得有些混乱的地方。版本控制分支和测试组织有一个共同点：他们都有成千上万的人告诉您应该如何做。该建议在很大程度上没有意义，因为他们真正说的是“这对我有用。

因此，在项目中使用版本控制，如果遇到工作流问题，请搜索可能的解决方案。记住，当你获得经验时，要回顾和调整你正在做的事情。

---
## 一个思想实验
    将整杯茶（英式早餐，加一点牛奶）洒在笔记本电脑键盘上。 将机器带到聪明人酒吧，让他们抬头皱眉。 买一台新电脑。 拿回家

    使该机器恢复到您最初举起那具命运的杯子时的状态需要多长时间？ 所有的 SSH 密钥，编辑器配置，shell 设置，已安装的应用程序等等？ 这发生在我们当中的一个人身上。

    定义原始计算机的配置和用法的几乎所有内容都存储在版本控制中，包括：

      * 所有用户首选项和点文件

      * 编辑器配置

      * 使用 Homebrew 安装的软件列表

      * 用于配置应用程序的 Ansible 脚本

      * 当前所有项目

    机器在下午结束时恢复了。

---

## 版本控制作为项目中心

尽管版本控制在个人项目上非常有用，但在与团队合作时确实会发挥作用。而且，这些价值中的大部分来自您托管资源库的方式。

现在，许多版本控制系统不需要任何托管。它们是完全分散的，每个开发人员都在对等基础上进行合作。但是即使使用这些系统，也值得考虑建立一个中央存储库，因为一旦这样做，您就可以利用大量的集成来简化项目流程。

许多存储库系统是开源的，因此您可以在公司中安装和运行它们。但这不是您真正的业务范围，因此我们建议大多数人托管第三方。查找以下功能：

- 良好的安全性和访问控制

- 直观的用户界面

- 也可以从命令行执行所有操作（因为您可能需要使其自动化）

- 自动化构建和测试

- 对分支合并的良好支持（有时称为拉取请求）

- 问题管理（理想情况下已集成到提交和合并中，因此您可以保留指标）

- 良好的报告（类似看板的未决问题和任务的显示非常有用）

- 良好的团队沟通：有关更改的电子邮件或其他通知，Wiki等

许多团队都配置了他们的VCS，以便推送到特定分支将自动构建系统，运行测试，以及如果成功将新代码部署到生产中。

听起来吓人吗？当您意识到正在使用版本控制时，情况并非如此。您可以随时将其回滚。

## 相关内容包括

- 话题 11 [_可逆性_](../Chapter2/可逆性.md)
- 话题 48 [_务实的团队_](../Chapter9/务实的团队.md)
- 话题 50 [_实用入门套件_](../Chapter9/实用入门套件.md)

## 挑战

- 知道可以使用VCS回滚到任何以前的状态是一回事，但是您实际上可以做到吗？您知道正确执行命令的命令吗？现在就学习它们，而不是在灾难袭来且您承受巨大压力时学习。

- 花一些时间考虑在发生灾难时恢复自己的笔记本电脑环境。您需要恢复什么？许多东西只是文本文件。如果它们不在VCS中（由笔记本电脑托管），请找到一种添加方式。然后考虑其他因素：已安装的应用程序，系统配置等。您如何在文本文件中表达所有这些内容，以便也可以保存。

  取得一些进展后，一个有趣的实验是找到不再使用的旧计算机，并查看是否可以使用新系统进行设置。

- 有意识地探索当前未使用的VCS和托管服务提供商的功能。如果您的团队没有使用功能分支，请尝试引入它们。拉/合并请求也是如此。持续集成。建立管道。甚至持续部署。还要研究团队沟通工具：Wiki，看板等。

  您不必使用任何一个。但是您确实需要知道它的作用，以便您做出决定。

- 也对非项目内容使用版本控制。
